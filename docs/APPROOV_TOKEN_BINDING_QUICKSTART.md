# Approov Token Binding Quickstart

This quickstart is for developers familiar with NodeJS who are looking for a quick intro into how they can add [Approov](https://approov.io) into an existing project. This will guide you through the necessary steps for adding Approov with token binding to an existing NodeJS GRPC server.

## TOC - Table of Contents

* [Requirements](#requirements)
* [Approov Setup](#approov-setup)
* [Approov Token Check](#approov-token-binding-check)
* [Try the Approov Integration Example](#try-the-approov-integration-example)


## Requirements

To complete this quickstart you will need

* NodeJS - Follow the [official installation instructions](https://nodejs.org/en/download/)
* Approov CLI - Follow our [installation instructions](https://approov.io/docs/latest/approov-installation/#approov-tool) and read more about each command and its options in the [documentation](https://approov.io/docs/latest/approov-cli-tool-reference/)

[TOC](#toc---table-of-contents)


## Approov Setup

To use Approov with the NodeJS API server we need a small amount of configuration.

### Configure API Domain

Approov needs to know the domain name of the API that will be protected and for which Approov will issue tokens.

Add it with this command:

```text
approov api -add your.api.domain.com
```

Adding the API domain also configures the [dynamic certificate pinning](https://approov.io/docs/latest/approov-usage-documentation/#approov-dynamic-pinning), out of the box.

> **NOTE:** By default the pin is extracted from the public key of the leaf certificate served by the domain, as visible to the box issuing the Approov CLI command and the Approov servers.

### Approov Secret

The NodeJS API server needs the Approov Base64 encoded secret that will be used to verify the tokens generated by the Approov cloud service.

Approov tokens are signed with a symmetric secret. To verify tokens, we need to retrieve the secret using the [Approov secret command](https://approov.io/docs/latest/approov-cli-tool-reference/#secret-command) and plug it into the NodeJS API server environment to check the signatures of the [Approov Tokens](https://www.approov.io/docs/latest/approov-usage-documentation/#approov-tokens) that it processes.

Retrieve the Approov secret with:

```text
approov secret -get base64
```

> **NOTE:** The `approov secret` command requires an [administration role](https://approov.io/docs/latest/approov-usage-documentation/#account-access-roles) to execute successfully.

#### Set the Approov Secret

Open the `.env` file and add the Approov secret to the var by replacing the string  `approov-base64-encoded-secret-here`:

```text
APPROOV_BASE64_SECRET=approov-base64-encoded-secret-here
```

[TOC](#toc---table-of-contents)


## Approov Token Check

The main functionality for the Approov token binding check is in the file [src/hello/approov-protected-server/token-binding-check/hello-server-protected.js](/src/hello/approov-protected-server/token-binding-check/hello-server-protected.js). See the `verifyApproovToken()` and `verifyApproovTokenBinding()` functions to find the code for the checks.

To check the Approov token we will use the [auth0/node-jsonwebtoken](https://github.com/auth0/node-jsonwebtoken#readme) package, but you are free to use another one of your preference.

Add these functions to your code:

```javascript
const verifyApproovToken = function(approovTokenHeader) {

  // Check that Approov token is present
  if (!approovTokenHeader || !approovTokenHeader.length) {
    // You may want to add some logging here.
    return null;
  }

  // Check that Approov token is valid
  try {
    const approovToken = approovTokenHeader[0];
    var decodedClaims = jwt.verify(approovToken, approovSecret, {algorithms: ["HS256"]});
  } catch(err) {
    // You may want to add some logging here.
    return null;
  }

  // The Approov token was successfully verified
  return decodedClaims;
}

const verifyApproovTokenBinding = function(boundAuthHeader, approovTokenClaims) {
  // The approovTokenClaims are null if the token didn't verify
  if (!approovTokenClaims) {
    // You may want to add some logging here.
    return false;
  }

  // Note that the `pay` (payload) claim will be present under normal circumstances. However, if the Approov failover
  // system is enabled, no `pay` claim will be present and if this is the case you want to return true, otherwise you
  // will not be able to benefit from the redundancy afforded by the failover system.
  if (!("pay" in approovTokenClaims)) {
    // You may want to add some logging here.
    return true;
  }
  bindingClaim = approovTokenClaims.pay

  // Check that the bound header is present
  if (!boundAuthHeader || !boundAuthHeader.length) {
    // You may want to add some logging here.
    return false;
  }

  // We need to compute the SHA256 hash of the token binding header, because this is what was included in the Approov
  // token in the mobile app.
  const boundAuthToken = boundAuthHeader[0]
  const hash = Buffer.from(crypto.createHash('sha256').update(boundAuthToken).digest('base64'), 'base64');
  var bindingHash = Buffer.from(bindingClaim, 'base64');
  return Buffer.compare(bindingHash, hash) == 0;
}
```

Now you just need to invoke it from the GRPC handler you want to be protected:

```javascript
function handleGRPC(call, callback) {

  // Get the Approov token and the bound authorization header from the metadata
  var approovTokenHeader = call.metadata.get('approov-token');
  var boundAuthHeader = call.metadata.get('authorization');

  var approovTokenClaims = verifyApproovToken(approovTokenHeader);

  // Get the bound authorization header from the metadata and check that the binding is valid

  if (!verifyApproovTokenBinding(boundAuthHeader, approovTokenClaims)) {
    const error = new Error("Unauthorized");
    console.log(error.message);
    callback(error, null);
    return;
  }

  // The Approov token and the binding are valid, continue with the call
  ...
}
```

> **NOTE:** When the Approov token validation fails we return an `Error("Unauthorized")` with no further information regarding the cause, because we do not want to give clues to an attacker about the reason the request failed.

A fully working example for a simple Hello World server can be found at [src/hello/approov-protected-server/token-binding-check](/src/hello/approov-protected-server/token-binding-check).

[TOC](#toc---table-of-contents)


## Test your Approov Integration

In the examples following below we show how to use [grpcurl](https://github.com/fullstorydev/grpcurl) to make the API requests. You can also use [Postman](https://www.postman.com/) which has recently added [GRPC support](https://blog.postman.com/postman-now-supports-grpc/). Just remember that you need to adjust the URLs and tokens in the examples to match your deployment.

#### With Valid Approov Tokens

Generate a valid token example from the Approov Cloud service:

```text
approov token -genExample your.domain.com -setDataHashInToken EXAMPLE_USER_AUTHORIZATON_CREDENTIALS
```

Then make the GRPC request with the generated token included in the metadata as an "Approov-Token" header, add
```text
  -H 'Approov-Token: <your_valid_token_example_here>' -H 'Authorization: EXAMPLE_USER_AUTHORIZATON_CREDENTIALS'
```
to the `grpcurl` command, where `<your_valid_token_example_here>` is replaced by the Approov token retrieved in the previous step.

The GRPC request should be accepted by the server and the expected response to the GRPC should be returned.

#### With Invalid Approov Tokens

Generate an invalid token example from the Approov Cloud service:

```text
approov token -type invalid -genExample your.domain.com -type invalid -setDataHashInToken EXAMPLE_USER_AUTHORIZATON_CREDENTIALS
```

Then make the request by adding
```text
  -H 'Approov-Token: <your_invalid_token_example_here> -H 'Authorization: EXAMPLE_USER_AUTHORIZATON_CREDENTIALS''
```
to your usual `grpcurl` request, where <your_invalid_token_example_here> is changed to the invalid token just generated. This should fail with an Unauthorized error.

#### With Invalid Token Binding

##### No Authorization Token

Let's just remove the Authorization header from the request and only add the Approov token header
```text
  -H 'Approov-Token: <your_valid_token_example_here>'
```
to the `grpcurl` command, where `<your_valid_token_example_here>` is replaced with the *valid* Approov token from before. The above request should fail with an Unauthorized error.

##### With a Different Authorization Token

Make the request with the *valid* approov token, but with a different authorization token:
```
  -H 'Approov-Token: <your_invalid_token_example_here> -H 'Authorization: DIFFERENT_EXAMPLE_USER_AUTHORIZATON_CREDENTIALS'
```
The above request should also fail with an Unauthorized error.


[TOC](#toc---table-of-contents)
